{% extends "base.html" %}
{% block content %}
<style>
  body {
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364) !important;
    color: #f1f1f1;
  }
  .chatbot-box {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    padding: 20px;
  }
  .chat-window {
    background: #fefefe;
    border-radius: 15px;
    border: 1px solid #ddd;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
    height: 400px;
    overflow-y: auto;
    padding: 10px;
  }
  .bot-message {
    background: #eef3ff;
    color: #1e3c72;
    padding: 10px 14px;
    border-radius: 12px;
    display: inline-block;
    max-width: 80%;
    margin-bottom: 8px;
  }
  .user-message {
    background: #d1ffd6;
    color: #055c1f;
    padding: 10px 14px;
    border-radius: 12px;
    display: inline-block;
    max-width: 80%;
    text-align: right;
    margin-bottom: 8px;
    float: none;
    clear: both;
  }
  .option-btn {
    display: block;
    width: 90%;
    max-width: 500px;
    margin: 8px auto;
    padding: 12px 20px;
    border-radius: 14px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    color: #fff;
  }
  .option-btn.lang { background: linear-gradient(135deg, #0072ff, #00c6ff); }
  .option-btn.decision { background: linear-gradient(135deg, #43cea2, #185a9d); }
  .option-btn.story { background: linear-gradient(135deg, #43cea2, #185a9d); } /* same look */
  .advice-card {
    background: #e0f7fa;
    border-left: 4px solid #00acc1;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    color: #004d40;
    font-weight: 500;
  }
  .stories-good {
    background: #e8f5e9;
    border-left: 4px solid #4caf50;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    color: #1b5e20;
    font-weight: 500;
  }
  .stories-bad {
    background: #fff3e0;
    border-left: 4px solid #fb8c00;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    color: #4e342e;
    font-weight: 500;
  }
  .startover {
    display: block;
    margin: 12px auto;
    padding: 12px 18px;
    border-radius: 14px;
    font-weight: bold;
    border: none;
    background: #4caf50;
    color: #fff;
    cursor: pointer;
  }
  .description-box {
    border-radius: 20px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  }
</style>

<div class="guidebot-container container py-5">
  <div class="description-box text-center p-5 mb-5" 
       style="background: linear-gradient(135deg, #1e3c72, #2a5298); color: #fff;">
    <h2 class="mb-3 fw-bold" style="font-size: 2rem;">ü§ñ GuideBot ‚Äì Conflict Assistant</h2>
    <p class="lead">
      üåç Your safety, your choices. / ÿ≥ŸÑÿßŸÖÿ™ŸÉÿå ŸÇÿ±ÿßÿ±ÿßÿ™ŸÉ.
    </p>
  </div>

  <div class="chatbot-box mx-auto" style="max-width: 800px;">
    <div class="chat-window" id="chat-window"></div>
    <div id="controls" class="mt-3 text-center"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
let LANG = null;
const chatWindow = document.getElementById("chat-window");
const controls = document.getElementById("controls");

function appendBot(text) {
  const d = document.createElement("div");
  d.className = "bot-message";
  d.innerHTML = text;
  chatWindow.appendChild(d);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function appendUser(text) {
  const d = document.createElement("div");
  d.className = "user-message";
  d.innerText = text;
  chatWindow.appendChild(d);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function clearControls() { controls.innerHTML = ""; }

// ======================= Language Selection =======================
function showLanguageSelection() {
  clearControls();
  appendBot("Please select a language / ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÑÿ∫ÿ©:");

  const options = [
    {key:"en", label:"English"},
    {key:"ar", label:"ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"}
  ];

  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "option-btn lang";
    btn.innerText = opt.label;
    btn.onclick = () => selectLanguage(opt.key);
    controls.appendChild(btn);
  });
}

async function selectLanguage(lang) {
  LANG = lang;
  appendUser(LANG==="ar"?"ÿßŸÑÿπÿ±ÿ®Ÿäÿ©":"English");
  try {
    await axios.post("/api/guide/set_lang", { lang: LANG });
  } catch (e) {
    console.warn("set_lang failed", e);
  }
  loadStart();
}

// ======================= Fetch Start Node =======================
async function loadStart() {
  clearControls();
  try {
    const res = await axios.get("/api/guide/start?lang=" + LANG);
    renderNode(res.data);
  } catch (err) {
    appendBot(LANG === 'ar' ? "‚ö† ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ." : "‚ö† Error fetching guide.");
    console.error(err);
  }
}

// ======================= Choose Option =======================
async function chooseOption(key, label) {
  appendUser(label);
  clearControls();
  try {
    const res = await axios.post("/api/guide/choose", { choice: key, lang: LANG });
    renderNode(res.data);
  } catch (err) {
    appendBot(LANG === 'ar' ? "‚ö† ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ." : "‚ö† Error connecting to server.");
    console.error(err);
  }
}


function renderNode(node) {
  if (!node) {
    appendBot(LANG === 'ar' ? "ÿπÿ∞ÿ±ÿßŸãÿå ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™." : "Sorry, no data.");
    return;
  }

  if (node.type === "question" || node.type === "sub_question") {
    if (node.question) appendBot(node.question);

    (node.options || []).forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "option-btn decision";
      let labelText = "";
      if (typeof opt.label === "object") {
        labelText = opt.label[LANG] || opt.label["en"] || opt.key;
      } else {
        labelText = opt.label || opt.key;
      }
      btn.innerText = labelText;
      btn.onclick = () => chooseOption(opt.key, labelText);
      controls.appendChild(btn);
    });

    const reset = document.createElement("button");
    reset.className = "startover";
    reset.innerText = LANG === "ar" ? "ÿßÿ®ÿØÿ£ ŸÖŸÜ ÿ¨ÿØŸäÿØ" : "Start Over";
    reset.onclick = () => {
      appendUser(reset.innerText);
      loadStart();
    };
    controls.appendChild(reset);

    return;
  }

  
  if (node.type === "leaf") {
    appendBot(LANG === "ar" ? "üìå ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿØÿπŸÖ" : "üìå Support Message");

    if (node.advice && node.advice.length > 0) {
      node.advice.forEach(a => {
        const div = document.createElement("div");
        div.className = "advice-card";
        div.innerText = a;
        chatWindow.appendChild(div);
      });
    }

    if (node.stories && node.stories.good && node.stories.good.length > 0) {
      const goodBtn = document.createElement("button");
      goodBtn.className = "option-btn story";
      goodBtn.innerText = LANG === "ar" ? "üìò ŸÜÿµÿßÿ¶ÿ≠ ÿ•Ÿäÿ¨ÿßÿ®Ÿäÿ©" : "üìò Positive Tips";
      goodBtn.onclick = () => {
        appendBot(LANG === "ar" ? "üìò ŸÜÿµÿßÿ¶ÿ≠ ÿ•Ÿäÿ¨ÿßÿ®Ÿäÿ©" : "üìò Positive Tips"); 
        node.stories.good.forEach(s => {
          const div = document.createElement("div");
          div.className = "stories-good";
          div.innerText = s;
          chatWindow.appendChild(div);
        });
        goodBtn.remove();
        chatWindow.scrollTop = chatWindow.scrollHeight;
      };
      controls.appendChild(goodBtn);
    }

    if (node.stories && node.stories.bad && node.stories.bad.length > 0) {
      const badBtn = document.createElement("button");
      badBtn.className = "option-btn story";
      badBtn.innerText = LANG === "ar" ? "‚ö†Ô∏è  ÿ™ÿ¨ÿßÿ±ÿ® ÿ≥ÿßÿ®ŸÇÿ© ÿÆÿßÿ∂Ÿáÿß ÿßŸÑÿßÿÆÿ±ŸàŸÜ" : "‚ö†Ô∏è Previous experiences undertaken by others";
      badBtn.onclick = () => {
        appendBot(LANG === "ar" ? "‚ö†Ô∏è ÿ™ÿ¨ÿßÿ±ÿ® ÿ≥ÿßÿ®ŸÇÿ© ÿÆÿßÿ∂Ÿáÿß ÿßŸÑÿßÿÆÿ±ŸàŸÜ" : "‚ö†Ô∏è Previous experiences undertaken by others"); 
        node.stories.bad.forEach(s => {
          const div = document.createElement("div");
          div.className = "stories-bad";
          div.innerText = s;
          chatWindow.appendChild(div);
        });
        badBtn.remove();
        chatWindow.scrollTop = chatWindow.scrollHeight;
      };
      controls.appendChild(badBtn);
    }

    const btnStartOver = document.createElement("button");
    btnStartOver.className = "startover";
    btnStartOver.innerText = LANG === "ar" ? "üîÑ ÿßÿ®ÿØÿ£ ŸÖŸÜ ÿ¨ÿØŸäÿØ" : "üîÑ Start Over";
    btnStartOver.onclick = () => loadStart();
    controls.appendChild(btnStartOver);

    return;
  }

  appendBot(LANG === "ar" ? "ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸÖ ÿ£ÿ≥ÿ™ÿ∑ÿπ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©." : "Sorry, I couldn't continue.");
}


showLanguageSelection();
</script>
{% endblock %}
